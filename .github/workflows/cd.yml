name: CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - production

concurrency:
  group: cd-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  choose-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set_env.outputs.environment }}
    steps:
      - name: Set deployment environment
        id: set_env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
          else
            echo "environment=production" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: choose-environment
    runs-on: ubuntu-latest
    environment: ${{ needs.choose-environment.outputs.environment }}
    steps:
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Prepare artifact (exclude .git, .github, etc.)
        run: |
          mkdir -p ./dist
          rsync -av --exclude='.git/' \
                       --exclude='.github/' \
                       --exclude='.gitignore' \
                       --exclude='setup-deploy-user.sh' \
                       --exclude='deploy.yml' \
                       --exclude='node_modules/' \
                       --exclude='vendor/' \
                       ./ ./dist/
          
          # Generate version file with deployment timestamp and environment
          DATE_FORMAT='%Y-%m-%dT%H:%M:%S+00:00'
          DEPLOY_TIME=$(date -u +"$DATE_FORMAT")
          ENVIRONMENT="${{ needs.choose-environment.outputs.environment }}"
          printf '%s\n' \
            '<?php' \
            '/**' \
            ' * TrendRadarConsole - Version File' \
            ' * ' \
            ' * This file is automatically updated during deployment.' \
            ' * Do not edit manually.' \
            ' */' \
            '' \
            'return [' \
            "    'updated_at' => '$DEPLOY_TIME'," \
            "    'environment' => '$ENVIRONMENT'," \
            '];' \
            > ./dist/version.php

      - name: üîë Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üöö Deploy via rsync
        env:
          SSH_HOST: ${{ vars.SSH_HOST }}
          SSH_USER: ${{ vars.SSH_USER }}
          TARGET_DIR: ${{ vars.TARGET_DIR }}
          BACKUP_DIR: ${{ vars.BACKUP_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "
            TARGET_DIR=\$(printf '%q' '$TARGET_DIR')
            BACKUP_DIR=\$(printf '%q' '$BACKUP_DIR')
            FOLDER_NAME=\$(basename \"\$TARGET_DIR\")
            TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
          
            # ÂàõÂª∫Â§á‰ªΩ
            mkdir -p \"\$BACKUP_DIR\"
            cp -r \"\$TARGET_DIR\" \"\$BACKUP_DIR/\${FOLDER_NAME}_\$TIMESTAMP\"
            echo \"‚úÖ Backup created: \${FOLDER_NAME}_\$TIMESTAMP\"
          
            # ‰øùÁïôÊúÄËøë3‰ªΩÔºàÊõ¥ÂÆâÂÖ®ÁöÑÂÜôÊ≥ïÔºâ
            (
              cd \"\$BACKUP_DIR\" || exit
              # ÂàóÂá∫ÂåπÈÖçÁõÆÂΩïÔºåÊåâ‰øÆÊîπÊó∂Èó¥ÂÄíÂ∫èÔºåË∑≥ËøáÂâç3‰∏™
              ls -1t \"\${FOLDER_NAME}_\"* 2>/dev/null | tail -n +4 | xargs -r rm -rf
            )
          "
          
          # rsync ÂêåÊ≠•ÔºàÂÖ≥ÈîÆÔºöÂºïÂè∑ + Êó†Á©∫Ê†ºÔºâ
          rsync -avz \
            --delete \
            --no-perms \
            --no-times \
            --exclude='.user.ini' \
            --exclude='.well-known/' \
            --exclude='.env*' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='config/config.php' \
            ./dist/ \
            "${SSH_USER}@${SSH_HOST}:${TARGET_DIR}/"

      - name: üîê Fix Permissions (Skip Sensitive Files)
        env:
          SSH_HOST: ${{ vars.SSH_HOST }}
          SSH_USER: ${{ vars.SSH_USER }}
        run: |
          chmod +x .github/scripts/fix-permissions.sh
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" \
            "mkdir -p /tmp/scripts && cat > /tmp/scripts/fix-permissions.sh" \
            < .github/scripts/fix-permissions.sh
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" \
            "chmod +x /tmp/scripts/fix-permissions.sh && sudo /tmp/scripts/fix-permissions.sh"

      - name: üóÉÔ∏è Run Database Migrations
        env:
          SSH_HOST: ${{ vars.SSH_HOST }}
          SSH_USER: ${{ vars.SSH_USER }}
          TARGET_DIR: ${{ vars.TARGET_DIR }}
          PHP_PATH: ${{ vars.PHP_PATH || 'php' }}
        run: |
          echo "Running database migrations..."
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "
            set -e
            cd \"$TARGET_DIR\" || exit 1
            if [ -f 'sql/migrate.php' ] && [ -f 'config/config.php' ]; then
              echo 'üì¶ Running migrations...'
              $PHP_PATH sql/migrate.php
              echo ''
              echo 'üîç Verifying migrations...'
              $PHP_PATH sql/migrate.php --verify
            else
              echo '‚ö†Ô∏è Skipping migrations: migrate.php or config.php not found'
            fi
          "

      # ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî ÂèØÈÄâÔºöÈÉ®ÁΩ≤ÊàêÂäüÈÄöÁü• ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
      # ‰æø‰∫é‰Ω†ÂêéÁª≠Êé•ÂÖ•„ÄåËá™Â∑±Êé®ÈÄÅÊ∂àÊÅØ„ÄçÁ≥ªÁªüÔºàÂ¶Ç‰ºÅ‰∏öÂæÆ‰ø° / Ëá™Âª∫ webhookÔºâ
      # - name: üì¢ Notify success
      #   if: success()
      #   env:
      #     NOTIFY_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
      #   run: |
      #     curl -sfSL -X POST "$NOTIFY_URL" \
      #       -H "Content-Type: application/json" \
      #       -d '{
      #         "title": "‚úÖ Deploy Success",
      #         "repo": "'"$GITHUB_REPOSITORY"'",
      #         "commit": "'"$GITHUB_SHA"'",
      #         "branch": "'"$GITHUB_REF_NAME"'",
      #         "author": "'"$GITHUB_ACTOR"'",
      #         "time": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
      #       }'
