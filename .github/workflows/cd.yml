name: CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›Žï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Prepare artifact (exclude .git, .github, etc.)
        run: |
          mkdir -p ./dist
          rsync -av --exclude='.git/' \
                       --exclude='.github/' \
                       --exclude='.gitignore' \
                       --exclude='setup-deploy-user.sh' \
                       --exclude='deploy.yml' \
                       --exclude='node_modules/' \
                       --exclude='vendor/' \
                       ./ ./dist/

      - name: ðŸ”‘ Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸšš Deploy via rsync
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          TARGET_DIR: ${{ vars.TARGET_DIR }}
          BACKUP_DIR: ${{ vars.BACKUP_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "
            TARGET_DIR=\$(printf '%q' '$TARGET_DIR')
            BACKUP_DIR=\$(printf '%q' '$BACKUP_DIR')
            FOLDER_NAME=\$(basename \"\$TARGET_DIR\")
            TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
          
            # åˆ›å»ºå¤‡ä»½
            mkdir -p \"\$BACKUP_DIR\"
            cp -r \"\$TARGET_DIR\" \"\$BACKUP_DIR/\${FOLDER_NAME}_\$TIMESTAMP\"
            echo \"âœ… Backup created: \${FOLDER_NAME}_\$TIMESTAMP\"
          
            # ä¿ç•™æœ€è¿‘3ä»½ï¼ˆæ›´å®‰å…¨çš„å†™æ³•ï¼‰
            (
              cd \"\$BACKUP_DIR\" || exit
              # åˆ—å‡ºåŒ¹é…ç›®å½•ï¼ŒæŒ‰ä¿®æ”¹æ—¶é—´å€’åºï¼Œè·³è¿‡å‰3ä¸ª
              ls -1t \"\${FOLDER_NAME}_\"* 2>/dev/null | tail -n +4 | xargs -r rm -rf
            )
          "
          
          # rsync åŒæ­¥ï¼ˆå…³é”®ï¼šå¼•å· + æ— ç©ºæ ¼ï¼‰
          rsync -avz \
            --delete \
            --no-perms \
            --no-times \
            --exclude='.user.ini' \
            --exclude='.well-known/' \
            --exclude='.env*' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            ./dist/ \
            "${SSH_USER}@${SSH_HOST}:${TARGET_DIR}/"

      - name: ðŸ” Fix Permissions (Skip Sensitive Files)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          chmod +x .github/scripts/fix-permissions.sh
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" \
            "mkdir -p /tmp/scripts && cat > /tmp/scripts/fix-permissions.sh" \
            < .github/scripts/fix-permissions.sh
          ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" \
            "chmod +x /tmp/scripts/fix-permissions.sh && /tmp/scripts/fix-permissions.sh"

      - name: â™»ï¸ Reload Apache
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            sudo systemctl restart httpd
            echo 'âœ… Apache reloaded'
          "

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” å¯é€‰ï¼šéƒ¨ç½²æˆåŠŸé€šçŸ¥ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # ä¾¿äºŽä½ åŽç»­æŽ¥å…¥ã€Œè‡ªå·±æŽ¨é€æ¶ˆæ¯ã€ç³»ç»Ÿï¼ˆå¦‚ä¼ä¸šå¾®ä¿¡ / è‡ªå»º webhookï¼‰
      # - name: ðŸ“¢ Notify success
      #   if: success()
      #   env:
      #     NOTIFY_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
      #   run: |
      #     curl -sfSL -X POST "$NOTIFY_URL" \
      #       -H "Content-Type: application/json" \
      #       -d '{
      #         "title": "âœ… Deploy Success",
      #         "repo": "'"$GITHUB_REPOSITORY"'",
      #         "commit": "'"$GITHUB_SHA"'",
      #         "branch": "'"$GITHUB_REF_NAME"'",
      #         "author": "'"$GITHUB_ACTOR"'",
      #         "time": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
      #       }'
