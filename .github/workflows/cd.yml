name: CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Prepare artifact (exclude .git, .github, etc.)
        run: |
          mkdir -p ./dist
          rsync -av --exclude='.git/' \
                       --exclude='.github/' \
                       --exclude='.gitignore' \
                       --exclude='setup-deploy-user.sh' \
                       --exclude='deploy.yml' \
                       --exclude='node_modules/' \
                       --exclude='vendor/' \
                       ./ ./dist/

      - name: ğŸ”‘ Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸšš Deploy via rsync
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          TARGET_DIR: ${{ secrets.TARGET_DIR }}
        run: |
          # åˆ›å»ºæ—¶é—´æˆ³å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä»½ï¼‰
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            cd $TARGET_DIR/../
            BACKUP_DIR='backup'
            TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
            
            # å¤‡ä»½å½“å‰
            cp -r \$(basename $TARGET_DIR) \"\$BACKUP_DIR/backup_\$TIMESTAMP\"
            echo 'âœ… Backup created: backup_\$TIMESTAMP'
            
            # ä¿ç•™æœ€è¿‘3ä»½å¤‡ä»½
            (ls -1t \$BACKUP_DIR/backup_* 2>/dev/null | tail -n +4 | xargs -r rm -rf)
          "

          # rsync åŒæ­¥ï¼ˆ--delete ä¿æŒä¸€è‡´ï¼›--exclude å·²åœ¨å‰æ­¥å¤„ç†ï¼‰
          rsync -avz \
            --delete \
            --exclude='.htaccess' \          # ğŸ›¡ï¸ é˜²æ­¢è¦†ç›–é¢æ¿é…ç½®
            --exclude='.user.ini' \          # ğŸ”’ å®å¡”æ ¸å¿ƒä¿æŠ¤
            # ğŸ”‘ è¯ä¹¦ç›®å½•
            --exclude='.well-known/' \
            --exclude='.env*' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            ./ \
            $SSH_USER@$SSH_HOST:$TARGET_DIR/

      - name: â™»ï¸ Reload Apache
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            sudo systemctl reload httpd
            echo 'âœ… Apache reloaded'
          "

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” å¯é€‰ï¼šéƒ¨ç½²æˆåŠŸé€šçŸ¥ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # ä¾¿äºä½ åç»­æ¥å…¥ã€Œè‡ªå·±æ¨é€æ¶ˆæ¯ã€ç³»ç»Ÿï¼ˆå¦‚ä¼ä¸šå¾®ä¿¡ / è‡ªå»º webhookï¼‰
      # - name: ğŸ“¢ Notify success
      #   if: success()
      #   env:
      #     NOTIFY_URL: ${{ secrets.NOTIFY_WEBHOOK_URL }}
      #   run: |
      #     curl -sfSL -X POST "$NOTIFY_URL" \
      #       -H "Content-Type: application/json" \
      #       -d '{
      #         "title": "âœ… Deploy Success",
      #         "repo": "'"$GITHUB_REPOSITORY"'",
      #         "commit": "'"$GITHUB_SHA"'",
      #         "branch": "'"$GITHUB_REF_NAME"'",
      #         "author": "'"$GITHUB_ACTOR"'",
      #         "time": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
      #       }'
